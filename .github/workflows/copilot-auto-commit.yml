name: Copilot Auto-Commit Workflow

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      issue_numbers:
        description: 'Comma-separated issue numbers to work on (e.g., 123,124,125)'
        required: false
        default: ''
      auto_commit:
        description: 'Auto-commit generated code? (true/false)'
        required: false
        default: 'true'
      run_tests:
        description: 'Run tests before committing? (true/false)'
        required: false
        default: 'true'

jobs:
  copilot-auto-code-generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov black mypy pylint

      - name: Install Node.js dependencies
        run: |
          if [ -f frontend/package.json ]; then
            cd frontend && npm install
          fi

      - name: Get open Copilot issues
        id: get-issues
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumbersInput = '${{ github.event.inputs.issue_numbers }}';
            let issues = [];

            if (issueNumbersInput) {
              // Use manually specified issues
              const numbers = issueNumbersInput.split(',').map(n => parseInt(n.trim()));
              for (const number of numbers) {
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number
                });
                issues.push(issue.data);
              }
            } else {
              // Get open issues with 'copilot-task' label
              const response = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'copilot-task,high-priority',
                per_page: 5,
                sort: 'created',
                direction: 'asc'
              });
              issues = response.data;
            }

            console.log(`Found ${issues.length} issues to work on`);

            // Save issues to output
            core.setOutput('issues', JSON.stringify(issues));
            core.setOutput('issue_count', issues.length);

            return issues;

      - name: Generate code suggestions using AI
        id: generate-code
        env:
          ISSUES_JSON: ${{ steps.get-issues.outputs.issues }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Generating code for Copilot tasks..."

          cat > generate_code.py << 'PYTHON_SCRIPT'
          import os
          import json
          import re
          from anthropic import Anthropic

          # Read issues
          issues_json = os.environ.get('ISSUES_JSON', '[]')
          issues = json.loads(issues_json)

          if not issues:
              print("No issues to process")
              exit(0)

          # Initialize Anthropic client
          client = Anthropic(api_key=os.environ.get('ANTHROPIC_API_KEY'))

          files_to_create = []

          for issue in issues:
              print(f"\n{'='*80}")
              print(f"Processing Issue #{issue['number']}: {issue['title']}")
              print(f"{'='*80}\n")

              # Extract file path from issue body
              file_match = re.search(r'\*\*File:\*\*\s+`([^`]+)`', issue['body'])
              if not file_match:
                  print(f"‚ö†Ô∏è  No file path found in issue #{issue['number']}")
                  continue

              file_path = file_match.group(1)
              print(f"üìÑ Target file: {file_path}")

              # Create prompt for Claude
              prompt = f"""You are a senior software engineer using GitHub Copilot to implement tasks.

Task: {issue['title']}

Requirements:
{issue['body']}

Generate high-quality, production-ready code for the file: {file_path}

Requirements:
1. Follow best practices for the language
2. Include comprehensive docstrings/comments
3. Add error handling
4. Include type hints (Python) or types (TypeScript)
5. Write clean, maintainable code
6. Add logging where appropriate

Generate ONLY the code, no explanations.
"""

              try:
                  # Call Claude API
                  response = client.messages.create(
                      model="claude-sonnet-4-5-20250929",
                      max_tokens=4000,
                      messages=[
                          {"role": "user", "content": prompt}
                      ]
                  )

                  generated_code = response.content[0].text

                  # Save file info
                  files_to_create.append({
                      'path': file_path,
                      'code': generated_code,
                      'issue_number': issue['number'],
                      'issue_title': issue['title']
                  })

                  print(f"‚úÖ Generated {len(generated_code)} characters of code")

              except Exception as e:
                  print(f"‚ùå Error generating code: {e}")
                  continue

          # Save files to disk
          for file_info in files_to_create:
              file_path = file_info['path']

              # Create directory if it doesn't exist
              dir_path = os.path.dirname(file_path)
              if dir_path:
                  os.makedirs(dir_path, exist_ok=True)

              # Write file
              with open(file_path, 'w') as f:
                  f.write(file_info['code'])

              print(f"üìù Created: {file_path}")

          # Save summary
          with open('generated_files.json', 'w') as f:
              json.dumps(files_to_create, f, indent=2)

          print(f"\n‚úÖ Generated {len(files_to_create)} files")
          PYTHON_SCRIPT

          python generate_code.py

      - name: Format code with Black (Python)
        run: |
          if ls *.py 2>/dev/null || find . -name "*.py" 2>/dev/null | grep -q .; then
            echo "Formatting Python files..."
            black . --exclude venv --exclude node_modules || true
          fi

      - name: Format code with Prettier (TypeScript/JavaScript)
        run: |
          if [ -f frontend/package.json ]; then
            cd frontend
            if ls src/**/*.{ts,tsx,js,jsx} 2>/dev/null; then
              echo "Formatting TypeScript/JavaScript files..."
              npx prettier --write "src/**/*.{ts,tsx,js,jsx}" || true
            fi
          fi

      - name: Run linters
        run: |
          echo "Running Python linters..."
          if ls *.py 2>/dev/null || find . -name "*.py" 2>/dev/null | grep -q .; then
            pylint **/*.py --exit-zero || true
            mypy . --ignore-missing-imports || true
          fi

      - name: Run tests
        id: run-tests
        if: github.event.inputs.run_tests != 'false'
        run: |
          echo "Running Python tests..."
          if [ -f pytest.ini ] || [ -d tests ]; then
            pytest -v --cov --cov-report=term-missing || echo "tests_failed=true" >> $GITHUB_OUTPUT
          fi

          echo "Running JavaScript tests..."
          if [ -f frontend/package.json ]; then
            cd frontend
            npm test -- --passWithNoTests || echo "frontend_tests_failed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to commit"
          fi

      - name: Commit generated code
        if: steps.check-changes.outputs.has_changes == 'true' && github.event.inputs.auto_commit != 'false'
        run: |
          git config --global user.name "GitHub Copilot Bot"
          git config --global user.email "copilot-bot@github.com"

          # Stage all changes
          git add .

          # Create commit message
          ISSUE_COUNT="${{ steps.get-issues.outputs.issue_count }}"

          git commit -m "$(cat <<'EOF'
          ü§ñ Copilot Auto-Generated Code - ${ISSUE_COUNT} Tasks

          Generated by GitHub Copilot workflow running every 2 hours.

          Tasks completed:
          $(cat generated_files.json | python -c "import sys, json; data = json.load(sys.stdin); print('\n'.join([f'- #{item[\"issue_number\"]}: {item[\"issue_title\"]}' for item in data]))" || echo "See generated_files.json for details")

          Files modified: $(git diff --cached --name-only | wc -l)

          Automated by: .github/workflows/copilot-auto-commit.yml
          EOF
          )"

          echo "‚úÖ Code committed locally"

      - name: Run tests on committed code
        if: steps.check-changes.outputs.has_changes == 'true' && github.event.inputs.run_tests != 'false'
        id: test-committed
        run: |
          echo "Running tests on committed code..."

          # Python tests
          if [ -f pytest.ini ] || [ -d tests ]; then
            if pytest -v --cov; then
              echo "python_tests=passed" >> $GITHUB_OUTPUT
            else
              echo "python_tests=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # JavaScript tests
          if [ -f frontend/package.json ]; then
            cd frontend
            if npm test -- --passWithNoTests; then
              echo "frontend_tests=passed" >> $GITHUB_OUTPUT
            else
              echo "frontend_tests=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Push changes
        if: steps.check-changes.outputs.has_changes == 'true' && steps.test-committed.outputs.python_tests == 'passed'
        run: |
          # Create new branch for changes
          BRANCH_NAME="copilot-auto-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME

          # Push to remote
          git push origin $BRANCH_NAME

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Changes pushed to branch: $BRANCH_NAME"
        id: push-changes

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true' && steps.test-committed.outputs.python_tests == 'passed'
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ steps.push-changes.outputs.branch_name }}
        with:
          script: |
            const branchName = process.env.BRANCH_NAME;
            const fs = require('fs');

            // Read generated files info
            let filesInfo = [];
            try {
              const data = fs.readFileSync('generated_files.json', 'utf8');
              filesInfo = JSON.parse(data);
            } catch (e) {
              console.log('Could not read generated_files.json');
            }

            // Create PR body
            const prBody = `## ü§ñ GitHub Copilot Auto-Generated Code

This PR contains code automatically generated by GitHub Copilot for the following tasks:

${filesInfo.map(f => `- #${f.issue_number}: ${f.issue_title}\n  - File: \`${f.path}\``).join('\n')}

---

## ‚úÖ Automated Checks

- [x] Code generated using Claude Sonnet 4.5
- [x] Code formatted (Black for Python, Prettier for TypeScript)
- [x] Linters run (pylint, mypy)
- [x] Tests passing${filesInfo.length > 0 ? '\n- [x] ' + filesInfo.length + ' files created/modified' : ''}

---

## üìä Statistics

**Files Modified:** ${filesInfo.length}
**Generated By:** GitHub Copilot Auto-Commit Workflow
**Branch:** \`${branchName}\`
**Workflow Run:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

---

## üéØ Next Steps

1. Review generated code
2. Test manually if needed
3. Merge if code quality is acceptable
4. Close related issues

---

## üîó Related Issues

${filesInfo.map(f => `Closes #${f.issue_number}`).join('\n')}

---

**Automated by:** \`.github/workflows/copilot-auto-commit.yml\`
**Frequency:** Every 2 hours
`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ Copilot Auto-Generated Code - ${filesInfo.length} Tasks`,
              head: branchName,
              base: 'main',
              body: prBody
            });

            console.log(`‚úÖ Pull request created: #${pr.data.number}`);
            console.log(`URL: ${pr.data.html_url}`);

            // Comment on related issues
            for (const file of filesInfo) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: file.issue_number,
                body: `ü§ñ **Copilot Auto-Generated Code**\n\nCode has been automatically generated for this task!\n\n**Pull Request:** #${pr.data.number}\n**File:** \`${file.path}\`\n\nPlease review the PR and merge if acceptable.`
              });
            }

            return pr.data;

      - name: Update Copilot usage stats
        if: always()
        run: |
          echo "üìä Copilot Usage Statistics"
          echo "============================="
          echo "Issues processed: ${{ steps.get-issues.outputs.issue_count }}"
          echo "Changes committed: ${{ steps.check-changes.outputs.has_changes }}"
          echo "Tests status: ${{ steps.test-committed.outputs.python_tests }}"
          echo ""
          echo "Check your Copilot usage: https://github.com/settings/copilot"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Copilot Auto-Commit Workflow Failed',
              body: `## ‚ùå Workflow Failure

The Copilot auto-commit workflow failed during the latest run.

**Workflow Run:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Triggered:** ${new Date().toISOString()}

Please check the workflow logs for details.

---

**Workflow:** \`.github/workflows/copilot-auto-commit.yml\`
`,
              labels: ['bug', 'automation', 'copilot']
            });

            console.log(`Created failure issue: #${issue.data.number}`);
