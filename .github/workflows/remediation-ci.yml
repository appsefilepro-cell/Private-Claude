name: Remediation Loop (Sandbox)

on:
  workflow_dispatch:
    inputs:
      target_score:
        description: 'Target remediation score (default: 97)'
        required: false
        default: '97'
        type: string
  schedule:
    - cron: '0 3 * * *'   # every day at 03:00 UTC
  push:
    branches:
      - 'claude/**'
    paths:
      - 'scripts/**'
      - 'config/**'
      - 'tests/**'
      - '.github/workflows/**'

env:
  TRADING_MODE: PAPER
  PYTHONUNBUFFERED: 1

jobs:
  remediation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install rich pyyaml bandit safety pytest pytest-cov black ruff mypy

      - name: Check Docker availability
        run: |
          docker --version
          docker-compose --version || docker compose version

      - name: Create docker-compose if missing
        run: |
          if [ ! -f docker-compose.yml ]; then
            cat > docker-compose.yml << 'EOF'
          version: '3.8'

          services:
            integration-sandbox:
              image: python:3.10-slim
              container_name: integration-sandbox
              command: sleep infinity
              working_dir: /workspace
              volumes:
                - .:/workspace
              environment:
                - PYTHONUNBUFFERED=1
                - TRADING_MODE=PAPER
              healthcheck:
                test: ["CMD", "python", "--version"]
                interval: 30s
                timeout: 10s
                retries: 3
          EOF
          fi

      - name: Bring up sandbox
        run: |
          if command -v docker-compose &> /dev/null; then
            docker-compose up --build -d
          else
            docker compose up --build -d
          fi
          sleep 10

      - name: Check sandbox health
        run: |
          if command -v docker-compose &> /dev/null; then
            docker-compose ps
            docker-compose logs integration-sandbox
          else
            docker compose ps
            docker compose logs integration-sandbox
          fi

      - name: Run security scans
        continue-on-error: true
        run: |
          echo "Running Bandit security scan..."
          bandit -r scripts/ -f json -o bandit-report.json || true

          echo "Running Safety check..."
          safety check --json > safety-report.json || true

      - name: Run code quality checks
        continue-on-error: true
        run: |
          echo "Running Black formatter check..."
          black --check scripts/ || true

          echo "Running Ruff linter..."
          ruff check scripts/ || true

          echo "Running MyPy type checker..."
          mypy scripts/ --ignore-missing-imports || true

      - name: Run tests
        continue-on-error: true
        run: |
          if [ -f tests/complete_system_test.py ]; then
            python tests/complete_system_test.py
          fi

      - name: Run remediation autopilot
        id: remediation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_PCT: ${{ inputs.target_score || '97' }}
        run: |
          python remediation_autopilot.py
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload remediation receipt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: remediation-receipt
          path: |
            REMEDIATION_RECEIPT.txt
            bandit-report.json
            safety-report.json
            ACTIVATION_STATUS.json
          retention-days: 90

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            reports/
            *.json
          retention-days: 30

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let receipt = 'Remediation receipt not found';

            try {
              receipt = fs.readFileSync('REMEDIATION_RECEIPT.txt', 'utf8');
            } catch (e) {
              console.log('Could not read receipt:', e.message);
            }

            const comment = `## Remediation Results

            \`\`\`
            ${receipt}
            \`\`\`

            See artifacts for detailed reports.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Update activation status
        if: always()
        run: |
          if [ -f ACTIVATION_STATUS.json ]; then
            echo "Current activation status:"
            cat ACTIVATION_STATUS.json
          fi

      - name: Commit remediation results
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -f REMEDIATION_RECEIPT.txt ]; then
            git add REMEDIATION_RECEIPT.txt
          fi

          if [ -f ACTIVATION_STATUS.json ]; then
            git add ACTIVATION_STATUS.json
          fi

          git diff --staged --quiet || git commit -m "üîß Automated remediation update - $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Push changes
        if: success()
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Tear down sandbox
        if: always()
        run: |
          if command -v docker-compose &> /dev/null; then
            docker-compose down --volumes
          else
            docker compose down --volumes
          fi

      - name: Set job status
        if: always()
        run: |
          if [ "${{ steps.remediation.outputs.exit_code }}" = "0" ]; then
            echo "‚úÖ Remediation completed successfully (‚â•97% target met)"
            exit 0
          else
            echo "‚ö†Ô∏è Remediation incomplete (score below 97% target)"
            echo "Check REMEDIATION_RECEIPT.txt artifact for details"
            exit 0  # Don't fail the workflow, just report status
          fi

  notify:
    needs: remediation
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download receipt
        uses: actions/download-artifact@v4
        with:
          name: remediation-receipt
          path: ./receipts

      - name: Send notification
        run: |
          echo "Remediation workflow completed"
          echo "Results available in artifacts"

          if [ -f receipts/REMEDIATION_RECEIPT.txt ]; then
            cat receipts/REMEDIATION_RECEIPT.txt
          fi

      # Optional: Add Slack notification if webhook URL is configured
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "üîß Remediation workflow completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Remediation Status*\nWorkflow: ${{ github.workflow }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }'
